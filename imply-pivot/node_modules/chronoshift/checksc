#!/bin/bash

echo '{"rules":{"semicolon": true}}' > tslint-sc.json

find src -name '*.ts' | while read f; do
  echo "Examine $f";

  node_modules/.bin/tslint -c tslint-sc.json -t json -f $f | jq 'map({ key: .startPosition.line | tostring, value: 1}) | from_entries' > lines.json;

  if [ -s lines.json ]
  then
    echo "Do $f";
    jq -s -R -r --argfile lines lines.json 'split("\n") | to_entries | .[] | .value + (if $lines[.key | tostring] then ";" else "" end)' $f > tmp.ts;
    mv tmp.ts $f;
  fi
done;

rm -f tslint-sc.json lines.json;
