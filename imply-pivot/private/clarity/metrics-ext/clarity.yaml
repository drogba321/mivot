# generated by Pivot version 0.7.34
# for a more detailed walk-through go to: https://github.com/implydata/pivot/blob/master/docs/configuration.md

port: 8089

druidHost: localhost:8082 # 172.31.14.252:8082

sourceListScan: disable

auth: auth.js

dataSources:

  - name: broker-query #------------------------------------------------------------------------
    title: Broker Queries
    engine: druid
    source: tubemogul-metrics
    timeAttribute: time
    refreshRule: { "rule": "realtime" }
    introspection: no-autofill

    subsetFilter: >
      $metric.in(['query/time', 'query/cpu/time', 'query/node/time', 'query/node/ttfb']) and
      $service.is("broker") and
      $host.contains("uat-") and
      $type != 'timeBoundary'

    defaultSortMeasure: avg-time
    defaultPinnedDimensions: ["dataSource", "type", "host"]

    dimensions:
      - { name: "time", title: "Time", kind: "time" }
      - { name: "dataSource", title: "Data Source" }
      - { name: "host", title: "Host" }
      - { name: "type", title: "Type" }
      - { name: "interval", title: "Interval" }
      - { name: "duration", title: "Duration" }
      - { name: "hasFilters", title: "Has Filters", type: "BOOLEAN" }
      - { name: "context", title: "Context" }
      - { name: "remoteAddress", title: "Remote Address" }
      - { name: "id", title: "ID" }
      - { name: "numMetrics", title: "Num Metrics" }
      - { name: "numComplexMetrics", title: "Num Complex Metrics" }
      - { name: "numDimensions", title: "Num Dimensions" }
      - { name: "dimension", title: "Dimension" }
      - { name: "threshold", title: "Threshold" }

    measures:
      - name: avg-time
        title: Avg. Time (ms)
        expression: $main.filter($metric == 'query/time').sum($sum) / $main.filter($metric == 'query/time').sum($count)

      - name: avg-cpu-time
        title: Avg. CPU Time (ms)
        expression: $main.filter($metric == 'query/cpu/time').sum($sum) / $main.filter($metric == 'query/cpu/time').sum($count)

      - name: avg-node-time
        title: Avg. Node Time (ms)
        expression: $main.filter($metric == 'query/node/time').sum($sum) / $main.filter($metric == 'query/node/time').sum($count)

      - name: avg-node-ttfb
        title: Avg. Node TTFB (ms)
        expression: $main.filter($metric == 'query/node/ttfb').sum($sum) / $main.filter($metric == 'query/node/ttfb').sum($count)

      - name: broker-count
        title: Broker Queries
        expression: $main.filter($metric == 'query/time').sum($count)

      - name: compute-count
        title: Compute Queries
        expression: $main.filter($metric == 'query/node/time').sum($count)

      - name: p95
        title: 95th Percentile
        expression: $main.quantile($histogram, 0.95)

      - name: p99
        title: 99th Percentile
        expression: $main.quantile($histogram, 0.99)


  - name: historical-query #------------------------------------------------------------------------
    title: Historical Queries
    engine: druid
    source: tubemogul-metrics
    timeAttribute: time

    refreshRule: { "rule": "realtime" }

    subsetFilter: >
      $metric.in(['query/time', 'query/cpu/time', 'query/node/time', 'query/node/ttfb']) and
      $service.is("historical") and
      $host.contains("uat-") and
      $type != 'timeBoundary'

    introspection: no-autofill

    defaultSortMeasure: avg-time
    defaultPinnedDimensions: ["dataSource", "type", "host"]

    dimensions:
      - { name: "time", title: "Time", kind: "time" }
      - { name: "dataSource", title: "Data Source" }
      - { name: "host", title: "Host" }
      - { name: "type", title: "Type" }
      - { name: "interval", title: "Interval" }
      - { name: "duration", title: "Duration" }
      - { name: "hasFilters", title: "Has Filters", type: "BOOLEAN" }
      - { name: "context", title: "Context" }
      - { name: "remoteAddress", title: "Remote Address" }
      - { name: "id", title: "ID" }
      - { name: "numMetrics", title: "Num Metrics" }
      - { name: "numComplexMetrics", title: "Num Complex Metrics" }
      - { name: "numDimensions", title: "Num Dimensions" }
      - { name: "dimension", title: "Dimension" }
      - { name: "threshold", title: "Threshold" }

    measures:
      - name: avg-time
        title: Avg. Time (ms)
        expression: $main.filter($metric == 'query/time').sum($sum) / $main.filter($metric == 'query/time').sum($count)

      - name: avg-cpu-time
        title: Avg. CPU Time (ms)
        expression: $main.filter($metric == 'query/cpu/time').sum($sum) / $main.filter($metric == 'query/cpu/time').sum($count)

      - name: avg-node-time
        title: Avg. Node Time (ms)
        expression: $main.filter($metric == 'query/node/time').sum($sum) / $main.filter($metric == 'query/node/time').sum($count)

      - name: avg-node-ttfb
        title: Avg. Node TTFB (ms)
        expression: $main.filter($metric == 'query/node/ttfb').sum($sum) / $main.filter($metric == 'query/node/ttfb').sum($count)

      - name: broker-count
        title: Broker Queries
        expression: $main.filter($metric == 'query/time').sum($count)

      - name: compute-count
        title: Compute Queries
        expression: $main.filter($metric == 'query/node/time').sum($count)

      - name: p95
        title: 95th Percentile
        expression: $main.quantile($histogram, 0.95)

      - name: p99
        title: 99th Percentile
        expression: $main.quantile($histogram, 0.99)


  - name: ingestion #------------------------------------------------------------------------
    title: Ingestion
    engine: druid
    source: tubemogul-metrics
    timeAttribute: time

    refreshRule: { "rule": "realtime" }

    subsetFilter: >
      $metric.in(["ingest/events/thrownAway", "ingest/events/unparseable", "ingest/events/processed", "ingest/rows/output", "ingest/persists/count", "ingest/persists/time", "ingest/persists/backPressure", "ingest/persists/failed", "ingest/handoff/failed"]) and
      $host.contains("uat-")

    defaultSortMeasure: processed

    defaultPinnedDimensions: ["dataSource", "host"]

    options:
      defaultSplitDimension: time

    introspection: no-autofill

    dimensions:
      - { name: "time", title: "Time", kind: "time" }
      - { name: "dataSource", title: "Data Source" }
      - { name: "host", title: "Host" }

    measures:
      - name: processed
        title: Processed
        expression: $main.filter($metric == 'ingest/events/processed').sum($sum)

      - name: unparseable
        title: Unparseable
        expression: $main.filter($metric == 'ingest/events/unparseable').sum($sum)

      - name: thrownAway
        title: Thrown Away
        expression: $main.filter($metric == 'ingest/events/thrownAway').sum($sum)

      - name: rows-output
        title: Rows Output
        expression: $main.filter($metric == 'ingest/rows/output').sum($sum)

      - name: persists-count
        title: Persists Count
        expression: $main.filter($metric == 'ingest/persists/count').sum($sum)

      - name: persists-time
        title: Persists Time
        expression: $main.filter($metric == 'ingest/persists/time').sum($sum)

      - name: persists-backpressure
        title: Persists Back Pressure
        expression: $main.filter($metric == 'ingest/persists/backPressure').sum($sum)

      - name: persists-failed
        title: Persists Failed
        expression: $main.filter($metric == 'ingest/persists/failed').sum($sum)

      - name: handoff-failed
        title: Handoff Failed
        expression: $main.filter($metric == 'ingest/handoff/failed').sum($sum)


  - name: all #------------------------------------------------------------------------
    title: All Metrics
    engine: druid
    source: tubemogul-metrics
    timeAttribute: time
    refreshRule: { "rule": "realtime" }

    subsetFilter: >
      $host.contains("uat-")

    defaultSortMeasure: count

    defaultPinnedDimensions: ["metric", "type"]

    introspection: no-autofill

    dimensions:
      - { name: "time", title: "Time", kind: "time" }
      - { name: "metric", title: "Metric" }
      - { name: "service", title: "Service" }
      - { name: "host", title: "Host" }
      - { name: "dataSource", title: "Data Source" }
      - { name: "type", title: "Type" }
      - { name: "interval", title: "Interval" }
      - { name: "hasFilters", title: "Has Filters" }
      - { name: "duration", title: "Duration" }
      - { name: "server", title: "Server" }
      - { name: "numMetrics", title: "Num Metrics" }
      - { name: "numComplexMetrics", title: "Num Complex Metrics" }
      - { name: "numDimensions", title: "Num Dimensions" }
      - { name: "dimension", title: "Dimension" }
      - { name: "threshold", title: "Threshold" }
      - { name: "id", title: "ID" }
      - { name: "remoteAddress", title: "Remote Address" }
      - { name: "memKind", title: "Mem Kind" }
      - { name: "taskType", title: "Task Type" }
      - { name: "tier", title: "Tier" }
      - { name: "segment", title: "Segment" }
      - { name: "context", title: "Context" }
      - { name: "taskStatus", title: "Task Status" }
      - { name: "gcName", title: "Gc Name" }
      - { name: "poolKind", title: "Pool Kind" }
      - { name: "poolName", title: "Pool Name" }
      - { name: "bufferpoolName", title: "Bufferpool Name" }
      - { name: "feed", title: "Feed" }

    measures:
      - name: count
        title: Count
        expression: $main.sum($count)

      - name: avg
        title: Average
        expression: $main.sum($sum) / $main.sum($count)

      - name: sum
        title: Sum
        expression: $main.sum($sum)

      - name: min
        title: Min
        expression: $main.min($min)

      - name: max
        title: Max
        expression: $main.max($max)

      - name: p95
        title: 95th Percentile
        expression: $main.quantile($histogram, 0.95)

      - name: p99
        title: 99th Percentile
        expression: $main.quantile($histogram, 0.99)


  - name: alerts
    title: Alerts Int
    engine: druid
    source: tubemogul-alerts

    refreshRule:
      rule: query
      refresh: PT1M

    defaultSortMeasure: count

    defaultPinnedDimensions: []

    introspection: no-autofill

    attributeOverrides:
    dimensions:
      - name: __time
        title: Time
        kind: time

      - name: description
        title: Description

      - name: feed
        title: Feed

      - name: host
        title: Host

      - name: service
        title: Service

      - name: severity
        title: Severity

    measures:
      - name: count
        title: Count
        expression: $main.sum($count)


linkViewConfig:
  title: Imply Clarity
  linkItems:

    # ------------------------------------ Queries ------------------------------------
    - name: broker-overview
      title: Broker Queries
      description: The queries that are made to the cluster over the past day
      group: Queries
      dataSource: broker-query
      essence:
        selectedMeasures: ["broker-count", "avg-time", "p99"]
        splits: time
        pinnedDimensions: ["dataSource", "type", "host"]

    - name: compute-overview
      title: Compute Queries
      description: The queries that are made to the computes over the past day
      group: Queries
      dataSource: broker-query
      essence:
        selectedMeasures: ["compute-count"]
        splits: time
        pinnedDimensions: ["dataSource", "type", "host"]

    - name: historical-overview
      title: Historical Queries
      description: The queries that are made to the historical node over the past day
      group: Queries
      dataSource: historical-query
      essence:
        selectedMeasures: ["avg-time"]
        splits: ['host', 'time']
        pinnedDimensions: ["dataSource", "type"]

    # ------------------------------------ Ingestion ------------------------------------
    - name: ingestion-overview
      title: Ingestion Overview
      description: The ingestion things that are happening now
      group: Ingestion
      dataSource: ingestion
      essence:
        selectedMeasures: ["processed", "unparseable", "thrownAway", "rows-output", "persists-count", "persists-time", "persists-backpressure", "persists-failed", "handoff-failed"]
        pinnedDimensions: ["dataSource", "host"]

    - name: ingestion-datasource
      title: Ingestion By Data Source
      description: Ingestion distributed across Data Sources
      group: Ingestion
      dataSource: ingestion
      essence:
        selectedMeasures: ["processed", "unparseable", "thrownAway", "rows-output"]
        splits: "dataSource"
        pinnedDimensions: ["host"]

    # ------------------------------------ Alerts ------------------------------------
    - name: alerts
      title: All Alerts
      description: The alerts that happen
      group: Alerts
      dataSource: alerts
      essence:
        selectedMeasures: ["count"]
        splits: 'description'
        pinnedDimensions: ["service", "severity", "host"]
